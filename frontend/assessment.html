<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Divorce Risk Assessment</title>
    <link rel="stylesheet" href="assessment-style.css">
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
      /* Simple modal styling */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        width: 400px;
      }
      .modal-content h3 {
        margin-top: 0;
      }
      .close-btn {
        float: right;
        cursor: pointer;
        font-size: 18px;
        color: #888;
      }
      .questions-list {
        margin-top: 15px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background: #f9f9f9;
      }
      .questions-list li {
        margin-bottom: 8px;
        padding: 6px;
        border-bottom: 1px solid #ddd;
      }
    </style>
  </head>
  <body class="welcome-page">
    <!-- Header -->
    <header class="welcome-header">
      <div class="header-content">
        <h1>Divorce Risk Assessment</h1>
        <a href="dashboard.html" class="back-btn">
          <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
      </div>
    </header>

    <!-- Main Sections -->
    <div class="dashboard-sections">
      <!-- Assessment Card -->
      <div class="dashboard-card">
        <h2>New Assessment</h2>
        <form id="assessmentForm">
          <label for="title">Assessment Title:</label>
          <input type="text" id="title" required />
          <button type="submit">Create Assessment</button>
        </form>
        <h3 id="assessmentTitleDisplay"></h3>
      </div>

      <!-- Questions Card -->
      <div class="dashboard-card" id="questionsCard" style="display: none">
        <h2>Questions</h2>
        <button id="openQuestionModal">+ Add Question</button>
        <ul class="questions-list" id="questionsList">
          <!-- Questions will appear here -->
        </ul>
      </div>

      <!-- Prediction Card -->
      <div class="dashboard-card" id="predictionCard" style="display: none">
        <h2>Run Prediction</h2>
        <button id="predictBtn">Predict</button>
        <pre id="predictResult"></pre>
      </div>
    </div>

    <!-- Question Modal -->
    <div class="modal" id="questionModal">
      <div class="modal-content">
        <span class="close-btn" id="closeModal">&times;</span>
        <h3>Add Question</h3>
        <form id="questionForm">
          <label>Question Text:</label>
          <input type="text" id="questionText" required />
          <label>Partner A Answer (0–4):</label>
          <input type="number" id="answerA" min="0" max="4" required />
          <label>Partner B Answer (0–4):</label>
          <input type="number" id="answerB" min="0" max="4" required />
          <button type="submit">Add</button>
        </form>
      </div>
    </div>

    <script src="app.js"></script>
    <script>
      const coupleId = Number(localStorage.getItem("currentCoupleId"));
      let currentAssessmentId = null;

      if (!coupleId) {
        alert("Couple not selected");
        window.location.href = "dashboard.html";
      }

      // Create Assessment
      document
        .getElementById("assessmentForm")
        ?.addEventListener("submit", async (e) => {
          e.preventDefault();

          const doctorId = localStorage.getItem("doctorId");
          if (!doctorId) {
            alert("Please login first");
            window.location.href = "index.html";
            return;
          }

          const data = {
            doctor_id: Number(doctorId),
            couple_id: coupleId,
            title: document.getElementById("title").value,
          };

          const res = await fetch(`${API_BASE}/assessments`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          if (!res.ok) {
            alert("Error creating assessment: " + (await res.text()));
            return;
          }

          const assessment = await res.json();
          currentAssessmentId = assessment.id;

          // Show title + enable questions/prediction
          document.getElementById(
            "assessmentTitleDisplay"
          ).textContent = `Assessment: ${assessment.title}`;
          document.getElementById("questionsCard").style.display = "block";
          document.getElementById("predictionCard").style.display = "block";
        });

      // Modal logic
      const modal = document.getElementById("questionModal");
      const openModal = document.getElementById("openQuestionModal");
      const closeModal = document.getElementById("closeModal");

      openModal.onclick = () => (modal.style.display = "flex");
      closeModal.onclick = () => (modal.style.display = "none");
      window.onclick = (e) => {
        if (e.target === modal) modal.style.display = "none";
      };

      // Add Question
      document
        .getElementById("questionForm")
        ?.addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!currentAssessmentId) {
            alert("No assessment selected");
            return;
          }

          const questionText = document.getElementById("questionText").value;
          const answerA = Number(document.getElementById("answerA").value);
          const answerB = Number(document.getElementById("answerB").value);

          const payload = {
            items: [
              {
                question_id: null,
                partner: "A",
                value: answerA,
                text: questionText,
              },
              {
                question_id: null,
                partner: "B",
                value: answerB,
                text: questionText,
              },
            ],
          };

          const res = await fetch(
            `${API_BASE}/assessments/${currentAssessmentId}/answers/bulk`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            }
          );

          if (!res.ok) {
            alert("Error adding answers: " + (await res.text()));
            return;
          }

          // Add to UI
          const li = document.createElement("li");
          li.textContent = `${questionText} → A: ${answerA}, B: ${answerB}`;
          document.getElementById("questionsList").appendChild(li);

          // Reset & close modal
          document.getElementById("questionForm").reset();
          modal.style.display = "none";
        });

      // Predict
      document
        .getElementById("predictBtn")
        ?.addEventListener("click", async () => {
          if (!currentAssessmentId) {
            alert("No assessment selected");
            return;
          }

          const res = await fetch(
            `${API_BASE}/assessments/${currentAssessmentId}/predict`,
            {
              method: "POST",
            }
          );

          if (!res.ok) {
            document.getElementById("predictResult").textContent =
              "Prediction failed: " + (await res.text());
            return;
          }

          const result = await res.json();
          document.getElementById("predictResult").textContent = JSON.stringify(
            result,
            null,
            2
          );
        });
    </script>
  </body>
</html>
